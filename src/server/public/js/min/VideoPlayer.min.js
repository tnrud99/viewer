class VideoPlayer{constructor(){this.youtubePlayer=null;this.reactionPlayer=null;this.reactionYoutubePlayer=null;this.isPlaying=false;this.youtubeReady=false;this.reactionYoutubeReady=false;this.youtubeVideoId=null;this.youtubeFirstPlayTime=null;this.youtubePaused=false;this.lastSyncTime=0;this.lastReactionTime=0;this.youtubeYoutubeMode=true;this.reactionYoutubeCurrentTime=0;this.lastReactionYoutubeTime=0;this.youtubeYoutubeSyncInterval=null;this.reactionYoutubeStateChangeTime=0;this.youtubeYoutubeSyncEnabled=true;this.youtubeYoutubeSyncFrequency=200;this.youtubeYoutubeSyncThreshold=0.3;this.reactionYoutubeState=-1;this.setupEventListeners()}onYouTubeIframeAPIReady(){this.youtubeReady=true;console.log('YouTube API Ready')}createYouTubePlayer(videoId,startTime=0){if(!this.youtubeReady){console.error('YouTube API not ready');return false}try{this.youtubePlayer=new YT.Player('youtube-player',{height:'100%',width:'100%',videoId:videoId,playerVars:{'autoplay':0,'controls':1,'rel':0,'showinfo':0,'modestbranding':1,'start':startTime},events:{'onReady':(event)=>this.onPlayerReady(event),'onStateChange':(event)=>this.onPlayerStateChange(event)}});return true}catch(error){console.error('Failed to create YouTube player:',error);return false}}createReactionYouTubePlayer(videoId,startTime=0){if(!this.youtubeReady){console.error('YouTube API not ready');return false}try{this.reactionYoutubePlayer=new YT.Player('reaction-youtube-container',{height:'100%',width:'100%',videoId:videoId,playerVars:{'autoplay':0,'controls':1,'rel':0,'showinfo':0,'modestbranding':1,'start':startTime},events:{'onReady':(event)=>this.onReactionPlayerReady(event),'onStateChange':(event)=>this.onReactionPlayerStateChange(event)}});return true}catch(error){console.error('Failed to create reaction YouTube player:',error);return false}}onPlayerReady(event){console.log('YouTube Player Ready');this.youtubePlayer=event.target;this.youtubePlayer.setVolume(100)}onReactionPlayerReady(event){console.log('Reaction YouTube Player Ready');this.reactionYoutubePlayer=event.target;this.reactionYoutubeReady=true;this.reactionYoutubePlayer.setVolume(100)}onPlayerStateChange(event){if(event.data===YT.PlayerState.PLAYING){this.youtubeStarted=true}}onReactionPlayerStateChange(event){this.reactionYoutubeState=event.data;this.reactionYoutubeStateChangeTime=Date.now();if(event.data===YT.PlayerState.PLAYING){this.reactionYoutubeCurrentTime=this.reactionYoutubePlayer.getCurrentTime()}}setupEventListeners(){if(this.reactionPlayer){this.reactionPlayer.addEventListener('loadedmetadata',()=>{console.log('Status: Reaction Video Loaded')});this.reactionPlayer.addEventListener('ended',()=>{this.stopSynchronizedPlayback()});this.reactionPlayer.addEventListener('timeupdate',()=>{if(!this.youtubeYoutubeMode){const currentTime=this.reactionPlayer.currentTime;this.handleSynchronization(currentTime)}})}}startSynchronizedPlayback(){if(this.isPlaying)return;this.isPlaying=true;this.updateButtonStates(true);if(this.youtubeYoutubeMode){this.startYoutubeYoutubeSync()}else{if(this.reactionPlayer){this.reactionPlayer.play()}}if(this.youtubePlayer&&this.youtubePlayer.playVideo){this.youtubePlayer.playVideo()}}pauseSynchronizedPlayback(){if(!this.isPlaying)return;this.isPlaying=false;this.updateButtonStates(false);if(this.youtubeYoutubeMode){this.stopYoutubeYoutubeSync()}else{if(this.reactionPlayer){this.reactionPlayer.pause()}}if(this.youtubePlayer&&this.youtubePlayer.pauseVideo){this.youtubePlayer.pauseVideo()}}restartSynchronizedPlayback(){this.pauseSynchronizedPlayback();setTimeout(()=>{if(this.youtubePlayer&&this.youtubePlayer.seekTo){this.youtubePlayer.seekTo(0)}if(this.reactionPlayer){this.reactionPlayer.currentTime=0}if(this.reactionYoutubePlayer&&this.reactionYoutubePlayer.seekTo){this.reactionYoutubePlayer.seekTo(0)}this.startSynchronizedPlayback()},100)}stopSynchronizedPlayback(){this.pauseSynchronizedPlayback();this.isPlaying=false;this.updateButtonStates(false)}startYoutubeYoutubeSync(){if(this.youtubeYoutubeSyncInterval){clearInterval(this.youtubeYoutubeSyncInterval)}this.youtubeYoutubeSyncInterval=setInterval(()=>{if(!this.isPlaying||!this.youtubeYoutubeSyncEnabled)return;if(this.reactionYoutubePlayer&&this.youtubePlayer){const reactionTime=this.reactionYoutubePlayer.getCurrentTime();const youtubeTime=this.youtubePlayer.getCurrentTime();if(Math.abs(reactionTime-youtubeTime)>this.youtubeYoutubeSyncThreshold){this.youtubePlayer.seekTo(reactionTime)}}},this.youtubeYoutubeSyncFrequency)}stopYoutubeYoutubeSync(){if(this.youtubeYoutubeSyncInterval){clearInterval(this.youtubeYoutubeSyncInterval);this.youtubeYoutubeSyncInterval=null}}handleSynchronization(currentTime){if(window.videoPlayer){window.videoPlayer.handleSynchronization(currentTime)}}updateButtonStates(playing){const playBtn=document.getElementById('play-btn');const pauseBtn=document.getElementById('pause-btn');const restartBtn=document.getElementById('restart-btn');if(playBtn)playBtn.disabled=playing;if(pauseBtn)pauseBtn.disabled=!playing;if(restartBtn)restartBtn.disabled=false}extractYouTubeVideoId(url){const regExp=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;const match=url.match(regExp);return(match&&match[2].length===11)?match[2]:null}getCurrentState(){return{isPlaying:this.isPlaying,youtubeReady:this.youtubeReady,reactionYoutubeReady:this.reactionYoutubeReady,youtubeYoutubeMode:this.youtubeYoutubeMode}}destroy(){this.stopSynchronizedPlayback();this.stopYoutubeYoutubeSync();if(this.youtubePlayer){this.youtubePlayer.destroy();this.youtubePlayer=null}if(this.reactionYoutubePlayer){this.reactionYoutubePlayer.destroy();this.reactionYoutubePlayer=null}}}window.VideoPlayer=VideoPlayer;
